# Release Please - Automated versioning and npm publishing
#
# How it works:
# 1. Every push to main with conventional commits updates a "Release PR"
# 2. When you merge the Release PR, it:
#    - Updates version in package.json
#    - Updates CHANGELOG.md
#    - Creates a GitHub Release with tag
#    - Triggers the npm publish job below
#
# Commit message format:
#   feat: add new feature          → minor version bump
#   fix: fix a bug                 → patch version bump
#   feat!: breaking change         → major version bump
#   chore/docs: no version bump
#
# npm Publishing:
#   Uses Trusted Publishing (OIDC) - no secrets needed!
#   Configure at: https://www.npmjs.com/package/@verygoodplugins/mcp-automem/access

name: Release Please

on:
    push:
        branches:
            - main

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        outputs:
            release_created: ${{ steps.release.outputs.release_created }}
            tag_name: ${{ steps.release.outputs.tag_name }}
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  release-type: node

    # Publish to npm when a release is created
    npm-publish:
        needs: release-please
        if: ${{ needs.release-please.outputs.release_created }}
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write  # Required for npm Trusted Publishing (OIDC)
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"

            - run: npm ci
            - run: npm run build
            - run: npm test
            
            # Trusted Publishing: No NPM_TOKEN needed!
            # Authentication happens via OIDC token exchange with npm
            - run: npm publish --access public --provenance

    # Build and upload Claude Desktop Extension (.mcpb) to release
    build-extension:
        needs: release-please
        if: ${{ needs.release-please.outputs.release_created }}
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - run: npm ci
            - run: npm run build
            
            # Build the .mcpb Claude Desktop Extension
            - name: Build Claude Desktop Extension
              run: npx @anthropic-ai/mcpb pack
            
            # Upload .mcpb to the GitHub release
            - name: Upload Extension to Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.release-please.outputs.tag_name }}
                  files: "*.mcpb"
